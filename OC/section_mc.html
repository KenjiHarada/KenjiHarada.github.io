<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>オンラインで学ぶ「モンテカルロ法」</title>

    <!-- Bootstrap -->
    <link href="../css/bootstrap_oc.min.css" rel="stylesheet">
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
      MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } });
    </script>
    <script type="text/javascript"
            src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
    </script>
    <script type="text/javascript" src="mc_pi.js" charset="UTF-8"></script>
  </head>
  <body onload="draw('mc_pi');">
    <ul class="pagination">
      <li><a href="index.html">&laquo;</a></li>
      <li><a href="index.html">はじめに</a></li>
      <li class="active"><a href="section_mc.html">期待値のモンテカルロ計算</a></li>
      <li><a href="section_mcmc.html">マルコフ連鎖モンテカルロ法</a></li>
      <li><a href="section_percolation.html">パーコレーション（浸透）</a></li>
      <li><a href="summary.html">おわりに</a></li>
      <li><a href="section_mcmc.html">&raquo;</a></li>
    </ul>

    <div class="container">
      <div class="row">
        <h1 id="sec:mc">期待値のモンテカルロ計算</h1>
        <p>
          システムが状態\(X\)になる確率を\(P(X)\)とする。その場合、状態\(X\)に依存する量 \(f(X)\)の期待値\(\langle f(X) \rangle\)は次式で定義される。<a href=#fn1 id="r1">[1]</a>:
        \begin{equation}
        \langle f(X) \rangle \equiv \sum_X f(X) P(X) \quad  \mbox{又は} ~ \int dX\ f(X) P(X),
        \end{equation}
        ここで、後者は状態変数\(X\)が連続変数だった場合を表す。</p>

        <p>状態の総数が少ない場合は全ての\(X\)について\(f(X) P(X)\)を足し上げる事で計算することができるが、例えば、\(X\)が\((x_1, x_2, ..., x_D)\)のような多成分の場合、多重和となり全列挙による計算は困難になる。
        \begin{eqnarray}
          \langle f(X) \rangle \equiv & \sum_{x_1}\cdots\sum_{x_D} f(x_1, \dots, x_D) P(x_1, \dots, x_D),\\
          \mbox{又は} \equiv & \int \cdots \int dx_1 \dots dx_D\ f(x_1, \dots, x_D) P(x_1, \dots, x_D).
        \end{eqnarray}
          実際、各\(X_i\)が\(K\)種類の値を取りうる時、状態総数は\(K^D\)となり、多重度\(D\)に対して指数関数的に増加する。連続変数の場合も同様である。例えば、\(D\)重積分の場合、それぞれの積分区間を\(K\)個ずつに分割すると積分領域は\(K^D\)個の積分要素に分割される。これは多重度\(D\)に対して指数関数的に大きくなるため、その全列挙は困難である。従って、多重度が大きな場合、全列挙しない方法が必要である。
        </p>

        <p>
          元々、各状態\(X\)が出現する確率が\(P(X)\)として与えられていたので、素朴に、確率\(P(X)\)に従って生成されたサンプル集団\(\{X_t\}\)の平均として、期待値を近似的に求めることができるように思われる。
          <div id="IIA1">
            \begin{equation}
            \langle
            f(X) \rangle \approx \frac{1}{M}\sum_{t=1, \dots, M} f(X_t).
            \end{equation}
          </div>
          このような計算手法を<strong>重み付きモンテカルロ法</strong>と呼ぶ<a href=#fn2 id="r2">[2]</a>。
        </p>
      </div>

      <div class="row">
        <p><a href=#IIA1>(4)</a>式右辺のサンプル値平均が真の期待値に収束することは容易に示す事ができる。サンプル値平均は確率変数の集合\(\{X_t\}\)によって定義されているのでこれ自身も確率変数と見なす事ができる。従って、その期待値を計算すると次の様になる。
          \begin{equation}
          \left\langle \frac{1}{M}\sum_{t=1, \dots, M} f(X_t) \right\rangle = \frac{1}{M}\sum_{t=1, \dots, M} \langle f(X_t) \rangle = \langle f(X) \rangle.
          \end{equation}
          分散も同様に計算すると、
          \begin{equation}
          \frac{1}{M}\left[\langle f^2(X)\rangle - \langle f(X)\rangle^2\right]
          \end{equation}
          となることがわかる。従って、サンプル数\(M\)が大きな極限で期待値\(\langle f(X) \rangle\)に収束する事が示せた。もう少し正確に言えば、
          <strong>中心極限定理</strong>により、重み付きモンテカルロ法で求めたサンプル平均値が、サンプル数\(M\)が大きい極限で、次の平均と分散をもつガウス分布に収束する事がわかる。
        <div id="II3">
          \begin{equation}
          \mbox{平均}\ \langle f(X) \rangle, ~ \mbox{分散}\
          \frac{1}{M}\left[\langle f^2(X)\rangle - \langle f(X)\rangle^2\right].
          \end{equation}
        </div>
        この結果からモンテカルロ法の誤差はサンプル数\(M\)が大きくなると\(\frac{1}{\sqrt{M}}\)で減少していくことがわかる。
        </p>
        
        <p>このように、モンテカルロ法は期待値の近似的な値を出すだけで、その誤差はサンプル数と共に減少していくが速度は早くはない。そのため、メリットがないように思われるが、上で述べたように全列挙が困難な場合、つまり、多重度が高い場合は誤差が多重度によらない事が大きなメリットになる。</p>

        <p>これまでは、期待値計算の手法として、モンテカルロ法を紹介してきたが、<strong>通常の多重積分や多重和</strong>も、適時、確率分布\(P(X)\)に相当するものを設定すれば、モンテカルロ法で計算可能となる。例えば、多重和の状態総数や多重積分の積分範囲の大きさがわかっている場合は、\(P(X)=\)1/(状態総数)、又は、1/(積分範囲の大きさ)に設定することができ、モンテカルロ法で多重和や多重積分が評価できる。</p>

        <p>上で述べたように<a href=#II3>(7)</a>式のガウス分布の分散のルートがモンテカルロ法の精度を意味するが、<a href=#II3>(7)</a>式自身の評価は通常できない。そこで,（独立な）モンテカルロ計算の平均値の集合\(\{\bar{f}_i\}\)から、近似的に分散を推定することで精度の評価を行うことがしばしば行われる。その場合、期待値の推定値とその精度は次式で与えられる.</p>
        <div id="II4">
          \begin{align}
          &\mbox{推定値}\ \bar{\bar{f}} \equiv \frac{\sum_i \bar{f}_i}{N_M},\nonumber\\
          &\mbox{精度} \equiv \sqrt{\frac{\sum_i \left(\bar{f}_i - \bar{\bar{f}}\right)^2}{N_M(N_M-1)}},
          \end{align}
        </div>
        <p>ここで、\(N_M\)は独立なモンテカルロ計算\(\{\bar{f}_i\}\)の回数である。</p>
      </div>
      <div class="row">
        <div class="col-md-4 col-md-offset-8">
          <img src="http://farm1.staticflickr.com/40/94680805_cd483658a2.jpg" width="323px" alt='Monte Carlo'>
          Photo:Monte Carlo By <a href='http://www.flickr.com/photos/herry/94680805/' target='_blank'>Herry Lawford</a>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <h2 id="sec:pi">乱数による円周率の計算</h2>
        <p>以下の積分にモンテカルロ法を適用し、円周率をモンテカルロ法で求める事を考える。</p>
        <div id="II5">
          \begin{equation}
          \int_0^1 dx \ \frac{4}{1+x^2} = \pi.
          \end{equation}
        </div>
        <p>いま、状態変数を区間\([0,1]\)に属する１次元実数\(X\)と考える。そして、確率密度を\(P(X)=1\)とすれば、円周率を\(\pi = \langle 4/(1+X^2) \rangle\)のように期待値と見なすことができ、モンテカルロ法によって期待値（円周率）を評価する事ができる。しかし、区間\([0,1]\)の一様分布に従うサンプル列\(\{X_t\}\)はどのように生成するのだろうか？</p>

        <p>ある区間にでたらめ（一様）に値をとる数を乱数と呼ぶ。乱数同士は定義より独立であるが、ルールに基づいて乱数を作成するとそのような事は原理的にはできない。しかし、実際上、ほぼ独立に見えるような<strong>擬似乱数</strong>の作り方がいくつか提案されている。例えば、C言語関数<a href="http://ja.wikipedia.org/wiki/Xorshift">xor128</a>は、区間\([0、2^{32}-1]\)の疑似乱数を作成する<a href=#fn3 id="r3">[3]</a>。この擬似乱数を区間の長さ(\(2^{32}\))で割る事で、区間\([0,1]\)の一様分布に従う疑似確率変数を作成することができる。現在、擬似乱数の研究は非常に進んでおり、標準的な関数として言語に内包されていたりライブラリー等の形で使用できるのでそれらの利用を勧める。</p>
      </div>
      <div class="row">
        <small>
          <p id="fn1"><a href="#r1">[1]</a> 例えば、\(f(X)\)は状態が\(X\)の時の対象からの出力値等。また、\(\langle \cdot \rangle\)は統計物理での期待値を表す記号である。
          </p>
          <p id="fn2"><a href="#r2">[2]</a>確率に基づく方法であるため、カジノで有名な都市にちなんだ名前が付いている。
          </p>
          <p id="fn3"><a href="#r3">[3]</a>本コードはunsigned longが４バイトであるC言語処理系を前提にしている。また、x, y, z, wは種と呼ばれる。ここでは適当な初期値を設定してある.
          </p>
        </small>
      </div>
      <div class="row">
        <div class="col-md-2 col-md-offset-10">
          <img src="http://farm9.staticflickr.com/8381/8561590798_46bd0efdd5_q.jpg" width="161px" height="161px" alt="pi">
          Photo:pi by <a href="http://www.flickr.com/photos/29233640@N07/8561590798/" title="pi by Robert Couse-Baker, on Flickr">Robert Couse-Baker</a>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <section id="sec:pi:p1">
          <h2>問題１</h2>
          <p>(1) 円周率を求める為に<a href=#II5>(9)</a>式の左辺のモンテカルロ計算を行う。サンプル数は\(10, 10^3, 10^5, 10^7\)とした独立な計算を10回おこなうことで、<a href=#II4>(8)</a>式から各サンプル数での推定値とその誤差を報告せよ。</p>
          <p>(2) 前問の結果と<a href=#II3>(7)</a>式と比較し、<a href=#II4>(8)</a>式の妥当性を検証せよ。</p>
        </section>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <figure id="demo_pi">
            <canvas align=center width="420" height="420" id="mc_pi"></canvas>
            <figcaption>
              <p>［円周率を表す<a href=#II5>(9)</a>式のモンテカルロ法によるサンプル平均値の様子］
                クリックするとサンプル数が変化する。短冊はサンプル値の場所に描かれ、その面積はサンプル平均への寄与分を表す。従って、短冊の総面積がサンプル平均値になっている。</p>
            </figcaption>
          </figure>
        </div>
      </div>
    </div>

    <ul class="pagination">
      <li><a href="index.html">&laquo;</a></li>
      <li><a href="index.html">はじめに</a></li>
      <li class="active"><a href="section_mc.html">期待値のモンテカルロ計算</a></li>
      <li><a href="section_mcmc.html">マルコフ連鎖モンテカルロ法</a></li>
      <li><a href="section_percolation.html">パーコレーション（浸透）</a></li>
      <li><a href="summary.html">おわりに</a></li>
      <li><a href="section_mcmc.html">&raquo;</a></li>
    </ul>

    <hr>
    <div class="container">
      <address>
        <a href="http://www-fcs.acs.i.kyoto-u.ac.jp/~harada/index.html">
        <strong>原田健自</strong>
        </a>
        <span class="glyphicon glyphicon-transfer"></span>
        <a href="http://www-fcs.acs.i.kyoto-u.ac.jp/~harada/index_en.html"><strong>Kenji Harada</strong></a><br>
        <span class="glyphicon glyphicon-envelope">
          <a href="mailto:harada@acs.i.kyoto-u.ac.jp">
            harada@acs.i.kyoto-u.ac.jp
          </a>
        </span><br>
        <span class="glyphicon glyphicon-user">
          京都市左京区吉田本町　京都大学吉田キャンパス　総合研究８号棟４１５号室
          <a href="http://www.kyoto-u.ac.jp/ja/access/campus/map6r_y.htm" class="label label-info">Map (No.59)</a>
        </span><br>
        <span class="glyphicon glyphicon-tower">
          <a href="http://www.i.kyoto-u.ac.jp/">
            京都大学大学院情報学研究科
          </a>助教</span>
      </address>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../js/bootstrap.min.js"></script>

  </body>
</html>
